-module(errdb_misc).

-export([pinfo/1,
        dropdot/1,
        version_compare/2,
        version_compare/3,
        incr/2]).

version_compare(A, B, lte) ->
    case version_compare(A, B) of
        eq -> true;
        lt -> true;
        gt -> false
    end;
version_compare(A, B, gte) ->
    case version_compare(A, B) of
        eq -> true;
        gt -> true;
        lt -> false
    end;
version_compare(A, B, Result) ->
    Result =:= version_compare(A, B).

version_compare(A, A) ->
    eq;
version_compare([], [$0 | B]) ->
    version_compare([], dropdot(B));
version_compare([], _) ->
    lt; %% 2.3 < 2.3.1
version_compare([$0 | A], []) ->
    version_compare(dropdot(A), []);
version_compare(_, []) ->
    gt; %% 2.3.1 > 2.3
version_compare(A,  B) ->
    {AStr, ATl} = lists:splitwith(fun (X) -> X =/= $. end, A),
    {BStr, BTl} = lists:splitwith(fun (X) -> X =/= $. end, B),
    ANum = list_to_integer(AStr),
    BNum = list_to_integer(BStr),
    if ANum =:= BNum -> version_compare(dropdot(ATl), dropdot(BTl));
       ANum < BNum   -> lt;
       ANum > BNum   -> gt
    end.

dropdot(A) -> lists:dropwhile(fun (X) -> X =:= $. end, A).

pinfo(Pid) ->
    Props = [registered_name, message_queue_len, memory,
        total_heap_size, heap_size, reductions],
	case process_info(Pid, Props) of
	undefined ->
		{{undefined, node()}, [undefined]};
	Info ->
		Name = proplists:get_value(registered_name, Info),
		{{Name, node()}, Info}
	end.

incr(Name, Val) ->
    case get(Name) of
    undefined ->
        put(Name, Val);
    OldVal ->
        put(Name, OldVal+Val)
    end.
    
